<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- PDF Template -->
    <template id="report_property_detail_document">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="product">
                <div class="article o_report_layout_standard">
                    <div class="page" t-attf-style="page-break-after: #{'always' if not product_last else 'avoid'};">
                        <style>
                            @page {
                                size: A4;
                                margin: 15mm 10mm 6mm 10mm;
                                margin-top: 15mm !important;
                            }
                            /* Force two-column layout - CRITICAL for wkhtmltopdf */
                            .info-row-table {
                                width: 180mm !important;
                                table-layout: fixed !important;
                                border-collapse: collapse !important;
                                page-break-inside: avoid !important;
                            }
                            .info-row-table tr {
                                page-break-inside: avoid !important;
                                page-break-after: avoid !important;
                            }
                            .info-row-table td {
                                display: table-cell !important;
                                vertical-align: top !important;
                            }
                            .info-col-1 {
                                width: 50mm !important;
                            }
                            .info-col-2 {
                                width: 130mm !important;
                            }
                            td {
                                border: hidden !important;
                            }
                            tr {
                                border: hidden !important;
                            }
                            .info-table tr {
                                border: none !important;
                                border-bottom: 1px solid #E5E7EB !important;
                            }
                            .info-table tr:last-child {
                                border-bottom: none !important;
                            }
                            .timeline-table td {
                                border: none !important;
                                border-bottom: 1px solid #F9ECC7 !important;
                            }
                            .timeline-table tr:last-child td {
                                border-bottom: none !important;
                            }
                            body {
                                margin: 0;
                                padding: 5mm 5mm 5mm 5mm;
                                font-family: 'DejaVu Sans', sans-serif;
                                color: #444;
                                background-color: #fff;
                                line-height: 1.3;
                                font-size: 9.5px;

                                border: 1px solid transparent !important;
                            }
                            
                            /* Typography */
                            .serif-title {
                                font-family: 'DejaVu Serif', serif;
                                color: #856404; /* Darker gold for better readability */
                                font-size: 22px;
                                font-weight: bold;
                                margin: 0;
                                line-height: 1;
                            }
                            .sub-title {
                                color: #9CA3AF;
                                font-size: 8px;
                                margin-top: 3px;
                                text-transform: uppercase;
                                letter-spacing: 1.2px;
                            }
                            
                            /* Common Header styles */
                            .section-header {
                                margin-bottom: 12px;
                                padding-bottom: 8px;
                                border-bottom: 1px solid #F3F4F6;
                            }
                            
                            /* Card Layout */
                            .layout-table {
                                width: 100%;
                                border-collapse: separate;
                                border-spacing: 8px 0;
                                margin: 0 -8px 15px -8px;
                            }
                            .card {
                                background: #F9FAFB;
                                border-radius: 6px;
                                padding: 10px;
                                vertical-align: top;
                                border: 1px solid #E5E7EB;
                            }
                            .full-card {
                                width: 100%;
                                background: #F9FAFB;
                                border-radius: 6px;
                                padding: 8px 10px;
                                border: 1px solid #F3F4F6;
                                margin-bottom: 8px;
                                box-sizing: border-box;
                                letter-spacing: 0.5px;
                            }
                            
                            /* Info Components */
                            .info-label { color: #888; font-size: 9px; padding: 4px 0; }
                            .info-value { color: #222; font-weight: 600; text-align: right; padding: 4px 0; }
                            .card-title {
                                color: #856404;
                                font-size: 10px;
                                font-weight: bold;
                                text-transform: uppercase;
                                margin-bottom: 10px;
                                letter-spacing: 0.5px;
                            }
                            
                            /* Financial Bar */
                            .price-highlight-bar {
                                background: #FFFBEB;
                                border: 1px solid #FFE082;
                                border-radius: 6px;
                                padding: 8px 15px;
                                margin-top: 8px;
                            }
                            .price-label { color: #856404; font-weight: bold; font-size: 8.5px; text-transform: uppercase; }
                            .price-value { color: #856404; font-size: 18px; font-weight: 800; float: right; margin-top: -3px; }

                            /* PREMIUM TIMELINE TABLE STYLE */
                            .timeline-section {
                                background: #FFFFFF;
                                border: 1px solid #FFE082;
                                border-radius: 12px;
                                padding: 15px;
                                margin-top: 15px;
                                position: relative;
                            }
                            .timeline-title-area {
                                margin-bottom: 15px;
                            }
                            .timeline-title {
                                color: #333;
                                font-size: 13px;
                                font-weight: bold;
                                display: block;
                            }
                            .timeline-subtitle {
                                color: #999;
                                font-size: 8.5px;
                                display: block;
                                margin-top: 2px;
                            }
                            
                            .timeline-table {
                                width: 100%;
                                border-collapse: separate !important;
                                border-spacing: 0;
                            }
                            .timeline-table th {
                                padding: 5px 8px;
                                text-align: left;
                                color: #888;
                                font-size: 8px;
                                font-weight: 600;
                                text-transform: uppercase;
                                border-bottom: none;
                                background: transparent;
                            }
                            .timeline-table td {
                                padding: 4px 8px;
                                font-size: 8.5px;
                                vertical-align: middle;
                            }
                            
                            /* Dot indicators */
                            .dot {
                                height: 6px;
                                width: 6px;
                                border-radius: 50%;
                                display: inline-block;
                                margin-right: 8px;
                                vertical-align: middle;
                            }
                            .dot-green { background-color: #4ADE80; }
                            .dot-grey { background-color: #D1D5DB; }
                            .dot-gold { background-color: #FFE082; }
                            
                            /* Bank column styling */
                            .bank-amount {
                                color: #856404;
                                font-weight: bold;
                                font-size: 10px;
                                display: block;
                                text-align: right;
                            }
                            .bank-note {
                                color: #999;
                                font-size: 8px;
                                display: block;
                                text-align: right;
                                margin-top: 2px;
                            }
                            
                            /* Total Bar */
                            .total-footer {
                                background: #FFE082;
                                border-radius: 8px;
                                padding: 10px 15px;
                                margin-top: 8px;
                                display: table;
                                width: 100%;
                                box-sizing: border-box;
                            }
                            .total-label { color: #856404; font-weight: bold; font-size: 11px; text-transform: uppercase; display: table-cell; vertical-align: middle; }
                            .total-values { text-align: right; display: table-cell; vertical-align: middle; }
                            .total-val-item { display: inline-block; margin-left: 25px; }
                            .gold-text { color: #000; font-weight: 800; }
                            .percentage-badge {
                                background: #000;
                                color: #FFE082;
                                padding: 3px 10px;
                                border-radius: 12px;
                                font-size: 8px;
                                font-weight: bold;
                                margin-left: 15px;
                            }
                            
                            .clearfix:after { content: ""; display: table; clear: both; }
                            .text-right { text-align: right; }
                        </style>
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 5px;">
                            <tr>
                                <td style="width: 50%; vertical-align: top; padding-left: 12px;">
                                    <t t-set="company" t-value="env.company"/>
                                    <t t-if="company.logo">
                                        <img t-att-src="image_data_uri(company.logo)" style="max-height: 35px; max-width: 130px;"/>
                                    </t>
                                </td>
                                <td style="width: 50%; text-align: right; vertical-align: top;">
                                    <t t-set="user" t-value="env.user"/>
                                    <div style="font-size: 8px; color: #666; line-height: 1.3; margin-right:15px;">
                                        <strong style="color: #333; font-size: 10px; display: block; margin-bottom: 1px;"><t t-esc="user.name"/></strong>
                                        <t t-set="phone" t-value="user.phone or user.mobile or user.partner_id.phone or user.partner_id.mobile"/>
                                        <t t-if="phone">SĐT: <t t-esc="phone"/> | </t>
                                        <t t-if="user.email"><t t-esc="user.email"/></t>
                                    </div>
                                </td>
                            </tr>
                        </table>

                        <div class="section-header" style="margin-bottom: 8px;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr>
                                    <td style="vertical-align: bottom;">
                                        <h1 class="serif-title" style="margin-bottom: 0; padding-left:15px;"><t t-esc="product.name"/></h1>
                                        <div class="sub-title" style="margin-top: 1px; padding-left:15px;">Hồng Hạc City • Khu đô thị cao cấp</div>
                                    </td>
                                    <td style="text-align: right; vertical-align: bottom; margin-right:15px;">
                                        <div t-attf-style="display: inline-block; padding: 4px 12px; border-radius: 5px; font-weight: bold; font-size: 10px; border: 1px solid #{'#DAFBE1' if not product.is_sold else '#FEE2E2'}; background-color: #{'#F0FDF4' if not product.is_sold else '#FEF2F2'}; color: #{'#166534' if not product.is_sold else '#DC2626'}; text-transform: uppercase;">
                                            <t t-if="product.is_sold">Đã bán</t>
                                            <t t-else="">Còn trống</t>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        
                        <div style="margin: 0 12px 10px 12px; white-space: nowrap; font-size: 0;">
                            <!-- Card 1: Thông Tin Cơ Bản -->
                            <div style="display: inline-block; vertical-align: top; width: 25%; margin-right: 1%; white-space: normal; font-size: 9.5px;">
                                <div style="background: #F9FAFB; border-radius: 6px; padding: 10px; border: 1px solid #E5E7EB; height: 100%;">
                                    <div class="card-title" style="margin-bottom: 6px;">Thông Tin Cơ Bản</div>
                                    <table class="info-table" style="width: 100%;">
                                        <tr><td class="info-label">Loại hình</td><td class="info-value">
                                            <t t-if="product.property_type == 'townhouse_garden'">Liền kề vườn</t>
                                            <t t-elif="product.property_type == 'detached_villa'">Biệt thự đơn lập</t>
                                            <t t-elif="product.property_type == 'semi_detached_villa'">Biệt thự song lập</t>
                                            <t t-elif="product.property_type == 'shophouse'">Shophouse</t>
                                            <t t-else="">---</t>
                                        </td></tr>
                                        <tr><td class="info-label">Hướng nhà</td><td class="info-value">
                                            <t t-set="direction_map" t-value="{'north': 'Bắc', 'northeast': 'Đông Bắc', 'east': 'Đông', 'southeast': 'Đông Nam', 'south': 'Nam', 'southwest': 'Tây Nam', 'west': 'Tây', 'northwest': 'Tây Bắc'}"/>
                                            <t t-esc="direction_map.get(product.direction, '---')"/>
                                        </td></tr>
                                        <tr><td class="info-label">Diện tích đất</td><td class="info-value"><t t-esc="product.area"/> m²</td></tr>
                                        <tr><td class="info-label">D.Tích xây dựng</td><td class="info-value"><t t-esc="product.construction_area or 0"/> m²</td></tr>
                                    </table>
                                </div>
                            </div>
                            <!-- Card 2: Thông Tin Thanh Toán -->
                            <div style="display: inline-block; vertical-align: top; width: 74%; white-space: normal; font-size: 9.5px;">
                                <div style="background: #F9FAFB; border-radius: 6px; padding: 10px; border: 1px solid #E5E7EB;">
                                    <div class="card-title" style="margin-bottom: 6px;">Thông Tin Thanh Toán</div>
                                    <t t-set="bank_accounts" t-value="product.env.company.bank_account_ids.filtered(lambda a: a.active)"/>
                                    <t t-set="bank" t-value="bank_accounts.filtered(lambda a: a.id == env.context.get('selected_bank_id'))[:1] or bank_accounts[:1]"/>
                                    <table t-if="bank" style="width: 100%;">
                                        <tr>
                                            <td style="vertical-align: top; width: 70%;">
                                                <table class="info-table" style="width: 100%; border-collapse: collapse;">
                                                    <tr><td class="info-label" style="padding: 2px 0;">CHỦ TÀI KHOẢN</td><td class="info-value" style="font-size: 8px;"><t t-esc="bank.bank_account_holder_name"/></td></tr>
                                                    <tr><td class="info-label" style="padding: 2px 0;">SỐ TÀI KHOẢN</td><td class="info-value" style="font-size: 10px; color: #000;"><t t-esc="bank.bank_account_number"/></td></tr>
                                                    <tr><td class="info-label" style="padding: 2px 0;">NGÂN HÀNG</td><td class="info-value"><t t-esc="bank.bank_name"/></td></tr>
                                                    <tr><td class="info-label" style="padding: 2px 0;">SWIFT CODE</td><td class="info-value"><t t-esc="bank.swift_code or '---'"/></td></tr>
                                                </table>
                                            </td>
                                            <td t-if="bank.payment_qr_code" style="vertical-align: top; width: 30%; text-align: right;">
                                                <img t-att-src="image_data_uri(bank.payment_qr_code)" style="max-height: 100px; max-width: 100px; border: 1px solid #EEE; padding: 2px; background: white;"/>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Financial Box -->
                        <div class="full-card">
                            <div class="card-title">Thông Tin Tài Chính (Dự kiến)</div>
                            <table style="width: 100%;">
                                <tr>
                                    <td style="width: 25%;" class="info-label">Giá (Chưa thuế SDĐ)</td>
                                    <td style="width: 25%;" class="info-value text-right"><t t-esc="'{:,.0f}'.format(product.price_exclude_land_tax or 0)"/> VNĐ</td>
                                    <td style="width: 10%;"></td>
                                    <td style="width: 20%;" class="info-label">Quỹ bảo trì</td>
                                    <td style="width: 20%;" class="info-value text-right"><t t-esc="'{:,.0f}'.format(product.maintenance_fee or 0)"/> VNĐ</td>
                                </tr>
                                <tr>
                                    <td class="info-label">Thuế sử dụng đất</td>
                                    <td class="info-value text-right"><t t-esc="'{:,.0f}'.format(product.land_tax or 0)"/> VNĐ</td>
                                    <td></td>
                                    <td class="info-label">Phí quản lý</td>
                                    <td class="info-value text-right"><t t-esc="'{:,.0f}'.format(product.management_fee or 0)"/> VNĐ/m²</td>
                                </tr>
                                 <tr>
                                     <td class="info-label">Số tiền đặt cọc</td>
                                     <td class="info-value text-right"><t t-esc="'{:,.0f}'.format(product.deposit or 0)"/> VNĐ</td>
                                     <td></td>
                                     <td class="info-label">Thuế VAT</td>
                                     <td class="info-value text-right"><t t-esc="'{:,.0f}'.format(product.vat_tax or 0)"/> VNĐ</td>
                                 </tr>
                            </table>
                            <div class="price-highlight-bar clearfix">
                                <span class="price-label">GIÁ NIÊM YẾT CÔNG BỐ</span>
                                <span class="price-value">
                                    <t t-esc="'{:,.0f}'.format(product.list_price)"/> <small style="font-size: 10px; vertical-align: baseline;">VNĐ</small>
                                </span>
                            </div>
                        </div>
                        
 
                        <!-- Timeline Section (Web Style) -->
                        <div class="timeline-section">
                            <div class="timeline-title-area">
                                <span class="timeline-title">Lịch thanh toán</span>
                                <span class="timeline-subtitle">Chi tiết từng đợt thanh toán cho sản phẩm <t t-esc="product.name"/></span>
                            </div>
                            
                            <table class="timeline-table">
                                <thead>
                                    <tr>
                                        <th style="width: 20%;">KỲ THANH TOÁN</th>
                                        <th style="width: 12%;">NGÀY</th>
                                        <th style="width: 20%;">MÔ TẢ</th>
                                        <th style="width: 12%; text-align: right;">TIỀN NHÀ</th>
                                        <th style="width: 10%; text-align: right;">VAT</th>
                                        <th style="width: 12%; text-align: right;">TỔNG TIỀN</th>
                                        <th style="width: 14%; text-align: right;">HỖ TRỢ<br/>NGÂN HÀNG</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-set="rows" t-value="product.payment_timeline_ids"/>
                                    <t t-foreach="rows" t-as="timeline">
                                        <t t-set="current_idx" t-value="rows.ids.index(timeline.id)"/>
                                        <t t-set="is_first_in_group" t-value="False"/>
                                        <t t-set="group_size" t-value="0"/>
                                        
                                        <t t-if="current_idx == 0 or rows[current_idx-1].bank_note != timeline.bank_note">
                                            <t t-set="is_first_in_group" t-value="True"/>
                                            <!-- Group size calculation without t-break -->
                                            <t t-set="temp_rows" t-value="rows[current_idx:]"/>
                                            <t t-set="stop_counting" t-value="False"/>
                                            <t t-foreach="temp_rows" t-as="next_row">
                                                <t t-if="not stop_counting and next_row.bank_note == timeline.bank_note">
                                                    <t t-set="group_size" t-value="group_size + 1"/>
                                                </t>
                                                <t t-else="">
                                                    <t t-set="stop_counting" t-value="True"/>
                                                </t>
                                            </t>
                                        </t>

                                        <tr>
                                            <td style="border-bottom: 1px solid #F9ECC7 !important;">
                                                <span style="font-weight: 600;">
                                                    <t t-set="type_labels" t-value="{'dat_coc': 'Đặt cọc', 'trong_3_ngay': 'Trong 3 ngày', 'ky_hop_dong': 'Ký Hợp Đồng', 'dot_4': 'Đợt 4', 'dot_5': 'Đợt 5', 'dot_6': 'Đợt 6', 'dot_7': 'Đợt 7', 'dot_8': 'Đợt 8', 'dot_9': 'Đợt 9', 'giao_nha': 'Giao nhà', 'quy_bao_tri': 'Quỹ bảo trì', 'thong_bao_so_hong': 'Thông báo sổ  hồng'}"/>
                                                    <t t-esc="type_labels.get(timeline.type, timeline.type)"/>
                                                </span>
                                            </td>
                                            <td style="color: #666; border-bottom: 1px solid #F9ECC7 !important;"><t t-if="timeline.date" t-esc="timeline.date.strftime('%d/%m/%Y')"/><t t-else="">---</t></td>
                                            <td style="color: #888; border-bottom: 1px solid #F9ECC7 !important;"><t t-esc="timeline.name"/></td>
                                            <td class="text-right" style="color: #555; border-bottom: 1px solid #F9ECC7 !important;"><t t-esc="'{:,.0f}'.format(timeline.amount)"/></td>
                                            <td class="text-right" style="color: #999; border-bottom: 1px solid #F9ECC7 !important;"><t t-if="timeline.vat_amount > 0" t-esc="'{:,.0f}'.format(timeline.vat_amount)"/><t t-else="">-</t></td>
                                            <td class="text-right" style="font-weight: 600; border-bottom: 1px solid #F9ECC7 !important;"><t t-esc="'{:,.0f}'.format(timeline.total_amount)"/></td>
                                            
                                            <!-- Grouped Bank Data -->
                                            <t t-if="is_first_in_group">
                                                <td t-att-rowspan="group_size" style="vertical-align: middle; border-bottom: 1px solid #F9ECC7 !important;">
                                                    <t t-set="sum_bank" t-value="sum(rows[current_idx:current_idx+group_size].mapped('bank_amount'))"/>
                                                    <t t-if="sum_bank > 0">
                                                        <span class="bank-amount"><t t-esc="'{:,.0f}'.format(sum_bank)"/></span>
                                                        <span class="bank-note"><t t-esc="timeline.bank_note"/></span>
                                                    </t>
                                                    <t t-else="">-</t>
                                                </td>
                                            </t>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                            
                            <!-- Total Footer Bar -->
                            <div class="total-footer">
                                <div class="total-label">TỔNG CỘNG</div>
                                <div class="total-values">
                                    <div class="total-val-item">
                                        <span class="info-label" style="display: block; text-align: left;">TIỀN NHÀ</span>
                                        <span class="gold-text"><t t-esc="'{:,.0f}'.format(sum(rows.mapped('amount')))"/></span>
                                    </div>
                                    <div class="total-val-item">
                                        <span class="info-label" style="display: block; text-align: left;">THUẾ VAT</span>
                                        <span class="gold-text"><t t-esc="'{:,.0f}'.format(sum(rows.mapped('vat_amount')))"/></span>
                                    </div>
                                    <div class="total-val-item">
                                        <span class="info-label" style="display: block; text-align: left;">TỔNG THANH TOÁN</span>
                                        <span class="gold-text" style="font-size: 14px;"><t t-esc="'{:,.0f}'.format(sum(rows.mapped('total_amount')))"/></span>
                                    </div>
                                    <span class="percentage-badge">100%</span>
                                </div>
                            </div>
                        </div><!-- close timeline-section -->
                       <!-- Discounts Section (Only if selected) -->
                        <div class="full-card" t-if="product.selected_discount_ids" style="margin-top: -5px; border-top: none; border-top-left-radius: 0; border-top-right-radius: 0; background: #FFFDF9;">
                            <div class="card-title" style="color: #856404; font-size: 9px;">Ưu đãi &amp; Chiết khấu áp dụng</div>
                            <table style="width: 100%; border-collapse: collapse;">
                                <t t-foreach="product.selected_discount_ids.sorted('sequence')" t-as="discount">
                                    <tr>
                                        <td class="info-label" style="padding: 3px 0;"><t t-esc="discount.name"/></td>
                                        <td class="info-value text-right" style="color: #DC2626; padding: 3px 0;">
                                            <t t-set="discount_amount" t-value="discount.compute_discount_for_product(product)"/>
                                            - <t t-esc="'{:,.0f}'.format(discount_amount)"/> VNĐ
                                            <t t-if="discount.discount_type == 'percent'">
                                                (<t t-esc="discount.discount_value"/>%)
                                            </t>
                                            <t t-elif="discount.discount_type == 'formula'">
                                                (<t t-esc="discount.discount_value"/> tháng)
                                            </t>
                                        </td>
                                    </tr>
                                </t>
                            </table>
                            <div class="price-highlight-bar clearfix" style="margin-top: 8px; background: #FEF3C7; border-color: #FCD34D;">
                                <span class="price-label" style="color: #92400E;">GIÁ SAU CHIẾT KHẤU</span>
                                <span class="price-value" style="color: #92400E; font-size: 20px;">
                                    <t t-esc="'{:,.0f}'.format(product.final_price)"/> <small style="font-size: 9px; vertical-align: baseline;">VNĐ</small>
                                </span>
                            </div>
                        </div>

                        <!-- Customer Greeting Footer -->
                        <t t-if="product.env.company.customer_greeting">
                            <div style="text-align: center; margin-top: 15px; padding-top: 10px; border-top: 1px dashed #E5E7EB;">
                                <p style="font-family: 'DejaVu Serif', serif; font-size: 15px; color: #856404; margin: 0; font-style: italic; white-space: pre-line;">
                                    <t t-esc="product.env.company.customer_greeting"/>
                                </p>
                            </div>
                        </t>
                        
                    </div><!-- close page -->
                </div><!-- close article -->
            </t><!-- close foreach -->
        </t><!-- close t-call -->
    </template>
</odoo>
