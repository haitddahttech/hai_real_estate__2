<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- Property Detail Page -->
    <template id="portal_property_detail" name="Property Detail">
        <t t-call="portal.portal_layout">
            <t t-set="additional_title" t-value="product.name"/>
            <t t-set="no_breadcrumbs" t-value="True"/>
            
            <style>
                .o_portal_submenu { display: none !important; }
                
                /* Document Grid Styles */
                .doc-grid-item {
                    position: relative;
                    overflow: hidden;
                    border-radius: 12px;
                    height: 200px;
                    background: #f8f9fa;
                    border: 1px solid #e9ecef;
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                }
                .doc-grid-item:hover {
                    box-shadow: 0 12px 30px rgba(0,0,0,0.12);
                    transform: translateY(-5px);
                }
                .doc-grid-preview {
                    height: 100%;
                    width: 100%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding-bottom: 40px;
                }
                .doc-grid-overlay {
                    position: absolute;
                    top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0, 0, 0, 0.7);
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    opacity: 0;
                    transition: all 0.3s ease;
                    gap: 12px;
                    padding: 20px;
                    z-index: 2;
                }
                .doc-grid-item:hover .doc-grid-overlay {
                    opacity: 1;
                }
                .doc-grid-info {
                    position: absolute;
                    bottom: 0; left: 0; width: 100%;
                    padding: 8px 12px;
                    background: rgba(255, 255, 255, 0.95);
                    border-top: 1px solid #eee;
                    font-size: 0.75rem;
                    z-index: 1;
                }
                .doc-grid-info .doc-name {
                    font-weight: 600;
                    color: #212529;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    display: block;
                }
                .doc-grid-info .doc-size {
                    color: #6c757d;
                    font-size: 0.7rem;
                }
                .hover-btn {
                    width: 110px;
                    transform: translateY(20px);
                    transition: all 0.3s ease;
                    opacity: 0;
                }
                .doc-grid-item:hover .hover-btn {
                    transform: translateY(0);
                    opacity: 1;
                }
                .btn-view { background-color: #0dcaf0; color: white; border: none; }
                .btn-view:hover { background-color: #0bacce; color: white; }
                
                /* ========== RESPONSIVE DESIGN FOR MOBILE ========== */
                
                /* Tablets and below (768px) */
                @media (max-width: 768px) {
                    .container {
                        padding-left: 15px !important;
                        padding-right: 15px !important;
                    }
                    
                    /* Make cards stack vertically on mobile */
                    .col-md-4 {
                        margin-bottom: 1rem;
                    }
                    
                    /* Reduce padding on mobile */
                    .card-body {
                        padding: 1rem !important;
                    }
                    
                    /* Smaller header on mobile */
                    .card-header h4 {
                        font-size: 1.1rem !important;
                    }
                    
                    /* Adjust badge size */
                    .badge.fs-6 {
                        font-size: 0.85rem !important;
                    }
                    
                    /* Make table text smaller on mobile */
                    .table {
                        font-size: 0.8rem !important;
                    }
                    
                    /* Reduce padding in table cells */
                    .table td, .table th {
                        padding: 0.4rem !important;
                    }
                    
                    /* Timeline table responsive */
                    .timeline-table {
                        font-size: 0.7rem !important;
                    }
                    
                    /* Discount section */
                    .list-group-item {
                        padding: 0.5rem !important;
                    }
                    
                    /* Final price card */
                    .card .d-flex {
                        flex-direction: column !important;
                        text-align: center !important;
                    }
                    
                    .card .d-flex > div {
                        margin-bottom: 0.5rem;
                    }
                }
                
                /* Mobile phones (576px and below) */
                @media (max-width: 576px) {
                    /* Even smaller container padding */
                    .container {
                        padding-left: 10px !important;
                        padding-right: 10px !important;
                    }
                    
                    /* Compact header */
                    .card-header {
                        padding: 0.5rem !important;
                    }
                    
                    .card-header h6 {
                        font-size: 0.75rem !important;
                    }
                    
                    /* Very compact tables */
                    .table {
                        font-size: 0.7rem !important;
                    }
                    
                    .table td, .table th {
                        padding: 0.3rem 0.2rem !important;
                    }
                    
                    /* Stack table rows for better readability */
                    .table td:first-child {
                        font-weight: 600;
                        width: 45%;
                    }
                    
                    /* Timeline table - make scrollable */
                    .table-responsive {
                        overflow-x: auto;
                        -webkit-overflow-scrolling: touch;
                    }
                    
                    .timeline-table {
                        min-width: 600px !important;
                        font-size: 0.65rem !important;
                    }
                    
                    /* Buttons full width on mobile */
                    .btn {
                        width: 100%;
                        margin-bottom: 0.5rem;
                    }
                    
                    /* Document grid - 1 column on mobile */
                    .row-cols-2, .row-cols-md-3, .row-cols-lg-4 {
                        --bs-columns: 1 !important;
                    }
                    
                    .doc-grid-item {
                        height: 150px;
                    }
                    
                    /* Payment content box */
                    .bg-light.p-2 {
                        font-size: 0.7rem !important;
                        padding: 0.5rem !important;
                    }
                    
                    /* Tabs */
                    .nav-tabs .nav-link {
                        font-size: 0.75rem !important;
                        padding: 0.5rem 0.75rem !important;
                    }
                    
                    /* Modal on mobile */
                    .modal-dialog {
                        margin: 0.5rem !important;
                    }
                    
                    /* Discount checkboxes */
                    .form-check-input {
                        width: 1rem !important;
                        height: 1rem !important;
                    }
                    
                    /* Final price */
                    h3 {
                        font-size: 1.3rem !important;
                    }
                    
                    h5 {
                        font-size: 1rem !important;
                    }
                }
                
                /* Touch-friendly improvements */
                @media (hover: none) and (pointer: coarse) {
                    /* Larger tap targets for touch devices */
                    .btn {
                        min-height: 44px;
                        padding: 0.75rem 1rem;
                    }
                    
                    .form-check-input {
                        min-width: 24px;
                        min-height: 24px;
                    }
                    
                    /* Remove hover effects on touch devices */
                    .doc-grid-item:hover {
                        transform: none;
                    }
                    
                    /* Show overlay by default on touch */
                    .doc-grid-overlay {
                        opacity: 0.9;
                        background: rgba(0, 0, 0, 0.5);
                    }
                }
            </style>
            
            <div class="container mt-4">
                <div class="row">
                    <div class="col-12">
                        <a t-if="product.site_plan_polygon_id" 
                           t-attf-href="/my/site-plan/#{product.site_plan_polygon_id.site_plan_id.id}" 
                           class="btn btn-secondary mb-3">
                            <i class="fa fa-arrow-left"/> Quay lại Bản đồ
                        </a>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-header bg-warning bg-opacity-25 text-dark d-flex justify-content-between align-items-center">
                                <!-- Left: Property Code -->
                                <div>
                                    <h4 class="mb-0">Mã căn: <t t-esc="product.name"/></h4>
                                </div>
                                
                                <!-- Center: Current User Name & Phone -->
                                <div class="text-center" style="font-size: 0.95rem; color: #495057;">
                                    <i class="fa fa-user me-1" style="font-size: 0.85rem;"></i>
                                    <span class="fw-semibold"><t t-esc="request.env.user.name"/></span>
                                    <t t-if="request.env.user.phone">
                                        <span class="mx-2">|</span>
                                        <i class="fa fa-phone me-1" style="font-size: 0.8rem;"></i>
                                        <span class="fw-normal"><t t-esc="request.env.user.phone"/></span>
                                    </t>
                                </div>
                                
                                <!-- Right: Status Badge -->
                                <div>
                                    <t t-if="product.is_sold">
                                        <span class="badge bg-danger fs-6">
                                            <i class="fa fa-check-circle"/> ĐÃ BÁN
                                        </span>
                                    </t>
                                    <t t-else="">
                                        <span class="badge bg-success fs-6">
                                            <i class="fa fa-home"/> CÒN TRỐNG
                                        </span>
                                    </t>
                                </div>
                            </div>
                            <div class="card-body">

                                <!-- Modern Property Details - Three Columns -->
                                <div class="row g-4 mt-2">
                                    <!-- Column 1: Basic Info (Smaller) -->
                                    <div class="col-md-4">
                                        <div class="card border-0 shadow-sm rounded-3 overflow-hidden h-100">
                                            <div class="card-header bg-light border-bottom py-2">
                                                <h6 class="mb-0 text-uppercase fw-bold text-dark ps-2" style="font-size: 0.85rem;">Thông Tin Cơ Bản</h6>
                                            </div>
                                            <table class="table table-hover mb-0 align-middle" style="font-size: 0.85rem;">
                                                <tbody>
                                                    <tr>
                                                        <td class="ps-3 py-2 text-muted">Mã căn</td>
                                                        <td class="pe-3 py-2 text-end fw-bold text-danger"><t t-esc="product.name"/></td>
                                                    </tr>
                                                    <tr>
                                                        <td class="ps-3 py-2 text-muted">Loại Hình</td>
                                                        <td class="pe-3 py-2 text-end fw-semibold text-dark">
                                                            <t t-if="product.property_type == 'townhouse_garden'">Liền kề vườn</t>
                                                            <t t-elif="product.property_type == 'detached_villa'">Biệt thự đơn lập</t>
                                                            <t t-elif="product.property_type == 'semi_detached_villa'">Biệt thự song lập</t>
                                                            <t t-elif="product.property_type == 'shophouse'">Shophouse</t>
                                                            <t t-else="">---</t>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="ps-3 py-2 text-muted">Hướng</td>
                                                        <td class="pe-3 py-2 text-end fw-semibold text-dark">
                                                            <t t-if="product.direction == 'north'">Bắc</t>
                                                            <t t-elif="product.direction == 'northeast'">Đông Bắc</t>
                                                            <t t-elif="product.direction == 'east'">Đông</t>
                                                            <t t-elif="product.direction == 'southeast'">Đông Nam</t>
                                                            <t t-elif="product.direction == 'south'">Nam</t>
                                                            <t t-elif="product.direction == 'southwest'">Tây Nam</t>
                                                            <t t-elif="product.direction == 'west'">Tây</t>
                                                            <t t-elif="product.direction == 'northwest'">Tây Bắc</t>
                                                            <t t-else="">---</t>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="ps-3 py-2 text-muted">DT đất</td>
                                                        <td class="pe-3 py-2 text-end fw-semibold text-dark"><t t-esc="product.area"/> m²</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="ps-3 py-2 text-muted">DT xây dựng</td>
                                                        <td class="pe-3 py-2 text-end fw-semibold text-dark"><t t-esc="product.construction_area or 0"/> m²</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- Column 2: Financial Info (MOVED UP) -->
                                    <div class="col-md-4">
                                        <div class="card border-0 shadow-sm rounded-3 overflow-hidden h-100">
                                            <div class="card-header bg-light border-bottom py-2">
                                                <h6 class="mb-0 text-uppercase fw-bold text-dark ps-2" style="font-size: 0.85rem;">Thông Tin Tài Chính</h6>
                                            </div>
                                            <table class="table table-hover mb-0 align-middle" style="font-size: 0.85rem;">
                                                <tbody>
                                                    <tr>
                                                        <td class="ps-3 py-2 text-muted">Giá chưa thuế SDĐ</td>
                                                        <td class="pe-3 py-2 text-end fw-semibold text-dark">
                                                            <t t-esc="'{:,.0f}'.format(product.price_exclude_land_tax or 0)"/>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="ps-3 py-2 text-muted">Thuế SDĐ</td>
                                                        <td class="pe-3 py-2 text-end fw-semibold text-dark">
                                                            <t t-esc="'{:,.0f}'.format(product.land_tax or 0)"/>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="ps-3 py-2 text-muted">Giá gồm SDĐ</td>
                                                        <td class="pe-3 py-2 text-end fw-semibold text-dark">
                                                            <t t-esc="'{:,.0f}'.format(product.price_include_land_tax or 0)"/>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="ps-3 py-2 text-muted">VAT</td>
                                                        <td class="pe-3 py-2 text-end fw-semibold text-dark">
                                                            <t t-esc="'{:,.0f}'.format(product.vat_tax or 0)"/>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="ps-3 py-2 text-muted">Quỹ bảo trì</td>
                                                        <td class="pe-3 py-2 text-end fw-semibold text-dark">
                                                            <t t-esc="'{:,.0f}'.format(product.maintenance_fee or 0)"/>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="ps-3 py-2 text-muted">Đặt Cọc</td>
                                                        <td class="pe-3 py-2 text-end fw-bold text-dark">
                                                            <t t-esc="'{:,.0f}'.format(product.deposit)"/>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="ps-3 py-2 text-muted">Giá niêm yết</td>
                                                        <td class="pe-3 py-2 text-end fw-bold text-dark">
                                                            <span id="listPriceValue" t-att-data-price="product.list_price">
                                                                <t t-esc="'{:,.0f}'.format(product.list_price)"/>
                                                            </span>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- Column 3: Payment Info (MOVED DOWN) -->
                                    <div class="col-md-4">
                                        <div class="card border-0 shadow-sm rounded-3 overflow-hidden h-100">
                                            <div class="card-header bg-warning bg-opacity-50 border-bottom py-2">
                                                <h6 class="mb-0 text-uppercase fw-bold text-dark ps-2" style="font-size: 0.85rem;">
                                                    <i class="fa fa-bank me-1"></i>Thông Tin Thanh Toán
                                                </h6>
                                            </div>
                                            <table class="table table-hover mb-0 align-middle" style="font-size: 0.85rem;">
                                                <tbody>
                                                    <tr>
                                                        <td class="ps-3 py-2 text-muted">Tên TK</td>
                                                        <td class="pe-3 py-2 text-end fw-semibold text-dark">
                                                            <t t-esc="request.env.company.bank_account_holder_name or '---'"/>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="ps-3 py-2 text-muted">Ngân hàng</td>
                                                        <td class="pe-3 py-2 text-end fw-semibold text-dark">
                                                            <t t-esc="request.env.company.bank_name or '---'"/>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="ps-3 py-2 text-muted">Số TK</td>
                                                        <td class="pe-3 py-2 text-end fw-bold text-primary">
                                                            <t t-esc="request.env.company.bank_account_number or '---'"/>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td colspan="2" class="ps-3 pe-3 py-2">
                                                            <div class="text-muted small mb-1">Nội dung thanh toán:</div>
                                                            <div class="fw-semibold text-dark bg-light p-2 rounded border" style="font-size: 0.8rem; word-break: break-word;">
                                                                <t t-set="site_plan_name" t-value="product.site_plan_polygon_id.site_plan_id.name if product.site_plan_polygon_id and product.site_plan_polygon_id.site_plan_id else 'N/A'"/>
                                                                Thanh toán căn <t t-esc="product.name"/> <t t-esc="site_plan_name"/>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                </div>

                                <!-- Tabs Section -->
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <ul class="nav nav-tabs" id="propertyTabs" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link active fw-bold" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline" type="button" role="tab" aria-controls="timeline" aria-selected="true">
                                                    <i class="fa fa-calendar-check-o me-1"></i> Lịch Trình Thanh Toán
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link fw-bold" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" type="button" role="tab" aria-controls="documents" aria-selected="false">
                                                    <i class="fa fa-file-text-o me-1"></i> Tài Liệu Dự Án
                                                </button>
                                            </li>
                                            <t t-if="product.description_sale">
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link fw-bold" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button" role="tab" aria-controls="description" aria-selected="false">
                                                        <i class="fa fa-info-circle me-1"></i> Mô Tả
                                                    </button>
                                                </li>
                                            </t>
                                        </ul>
                                        
                                        <div class="tab-content border-start border-end border-bottom bg-white p-4 rounded-bottom shadow-sm" id="propertyTabsContent">
                                            <!-- Tab 1: Payment Timeline -->
                                            <div class="tab-pane fade show active" id="timeline" role="tabpanel" aria-labelledby="timeline-tab">
                                                <t t-if="product.payment_timeline_ids">
                                                        <style>
                                                            .timeline-header th {
                                                                background-color: #ffd087 !important;
                                                                border: 1px solid #dee2e6 !important;
                                                                color: #1a1a1a !important;
                                                                font-weight: 900 !important;
                                                                vertical-align: middle;
                                                            }
                                                            .timeline-table td {
                                                                border: 1px solid #dee2e6 !important;
                                                                vertical-align: middle;
                                                            }
                                                            .bg-cyan-bank {
                                                                background-color: #4dd0e1 !important;
                                                            }
                                                            .timeline-total {
                                                                background-color: #fff9f0 !important;
                                                                font-weight: bold;
                                                                border-top: 2px solid #333 !important;
                                                            }
                                                        </style>
                                                        <div class="table-responsive">
                                                            <table class="table table-bordered timeline-table text-center mb-0" style="font-size: 0.85rem; border: 1px solid #333; min-width: 900px;">
                                                                <thead class="timeline-header">
                                                                    <tr>
                                                                        <th rowspan="2" class="align-middle">Kỳ thanh toán</th>
                                                                        <th rowspan="2" class="align-middle">Ngày thanh toán</th>
                                                                        <th rowspan="2" class="align-middle">Số tiền thanh toán</th>
                                                                        <th rowspan="2" class="align-middle">Tiền nhà</th>
                                                                        <th rowspan="2" class="align-middle">VAT</th>
                                                                        <th rowspan="2" class="align-middle bg-warning bg-opacity-15">TỔNG TIỀN</th>
                                                                        <th colspan="2" class="align-middle bg-warning bg-opacity-15">HỖ TRỢ NGÂN HÀNG</th>
                                                                    </tr>
                                                                    <tr>
                                                                        <th style="width: 130px;">Số tiền</th>
                                                                        <th style="width: 180px;">Ghi chú</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    <t t-set="processed_notes" t-value="[]"/>
                                                                    <t t-foreach="product.payment_timeline_ids" t-as="timeline">
                                                                        <tr t-att-class="'bg-light' if timeline.type in ['ky_hop_dong', 'giao_nha'] else ''">
                                                                            <td t-att-class="'fw-bold' if timeline.type in ['ky_hop_dong', 'giao_nha'] else ''">
                                                                                <t t-if="timeline.type == 'dat_coc'">Đặt cọc</t>
                                                                                <t t-elif="timeline.type == 'trong_3_ngay'">Trong 3 ngày</t>
                                                                                <t t-elif="timeline.type == 'ky_hop_dong'">Ký Hợp Đồng</t>
                                                                                <t t-elif="timeline.type == 'dot_4'">Đợt 4</t>
                                                                                <t t-elif="timeline.type == 'dot_5'">Đợt 5</t>
                                                                                <t t-elif="timeline.type == 'dot_6'">Đợt 6</t>
                                                                                <t t-elif="timeline.type == 'dot_7'">Đợt 7</t>
                                                                                <t t-elif="timeline.type == 'dot_8'">Đợt 8</t>
                                                                                <t t-elif="timeline.type == 'dot_9'">Đợt 9</t>
                                                                                <t t-elif="timeline.type == 'giao_nha'">Giao nhà</t>
                                                                                <t t-elif="timeline.type == 'quy_bao_tri'">Quỹ bảo trì</t>
                                                                                <t t-elif="timeline.type == 'thong_bao_so_hong'">Thông báo sổ hồng</t>
                                                                                <t t-else=""><t t-esc="timeline.type"/></t>
                                                                            </td>
                                                                            <td>
                                                                                <t t-if="timeline.date">
                                                                                    <t t-esc="timeline.date.strftime('%d/%m/%Y')"/>
                                                                                </t>
                                                                            </td>
                                                                            <td t-att-class="'fw-bold' if timeline.type in ['ky_hop_dong'] else ''">
                                                                                <t t-esc="timeline.name"/>
                                                                            </td>
                                                                            <td class="text-end">
                                                                                <t t-if="timeline.amount and timeline.amount > 0">
                                                                                    <t t-esc="'{:,.0f}'.format(timeline.amount)"/>
                                                                                </t>
                                                                            </td>
                                                                            <td class="text-end">
                                                                                <t t-if="timeline.vat_amount and timeline.vat_amount > 0">
                                                                                    <t t-esc="'{:,.0f}'.format(timeline.vat_amount)"/>
                                                                                </t>
                                                                            </td>
                                                                            <td class="text-end fw-bold">
                                                                                <t t-if="timeline.total_amount and timeline.total_amount > 0">
                                                                                    <t t-esc="'{:,.0f}'.format(timeline.total_amount)"/>
                                                                                </t>
                                                                            </td>
                                                                            
                                                                            <!-- Bank Support Column with Rowspan -->
                                                                            <t t-if="timeline.bank_note not in processed_notes">
                                                                                <t t-set="group_lines" t-value="product.payment_timeline_ids.filtered(lambda l: l.bank_note == timeline.bank_note)"/>
                                                                                <t t-set="dummy" t-value="processed_notes.append(timeline.bank_note)"/>
                                                                                
                                                                                <td t-att-rowspan="len(group_lines)" 
                                                                                    t-att-class="'bg-cyan-bank' if timeline.type in ['dat_coc', 'quy_bao_tri'] else ''"
                                                                                    class="text-end fw-bold align-middle">
                                                                                    <t t-set="note_total" t-value="sum(group_lines.mapped('bank_amount'))"/>
                                                                                    <t t-if="note_total > 0">
                                                                                        <t t-esc="'{:,.0f}'.format(note_total)"/>
                                                                                    </t>
                                                                                </td>
                                                                                <td t-att-rowspan="len(group_lines)" class="align-middle fw-semibold text-danger">
                                                                                    <t t-esc="timeline.bank_note"/>
                                                                                </td>
                                                                            </t>
                                                                        </tr>
                                                                    </t>
                                                                </tbody>
                                                                <t t-set="total_house" t-value="sum(product.payment_timeline_ids.mapped('amount'))"/>
                                                                <t t-set="total_vat" t-value="sum(product.payment_timeline_ids.mapped('vat_amount'))"/>
                                                                <t t-set="total_all" t-value="sum(product.payment_timeline_ids.mapped('total_amount'))"/>
                                                                <t t-set="total_bank" t-value="sum(product.payment_timeline_ids.mapped('bank_amount'))"/>
                                                                <t t-set="total_percent" t-value="100"/>
                                                                <tfoot class="timeline-total">
                                                                    <tr>
                                                                        <td colspan="3" class="text-danger fw-bold text-uppercase">TỔNG GIÁ</td>
                                                                        <td class="text-end"><t t-esc="'{:,.0f}'.format(total_house)"/></td>
                                                                        <td class="text-end"><t t-esc="'{:,.0f}'.format(total_vat)"/></td>
                                                                        <td class="text-end text-danger"><t t-esc="'{:,.0f}'.format(total_all)"/></td>
                                                                        <td class="text-end"><t t-esc="'{:,.0f}'.format(total_bank)"/></td>
                                                                        <td>100%</td>
                                                                    </tr>
                                                                </tfoot>
                                                            </table>
                                                        </div>
                                                </t>
                                                <t t-else="">
                                                    <div class="text-center py-4 text-muted">
                                                        <i class="fa fa-info-circle me-2"></i> Chưa có lịch trình thanh toán cho sản phẩm này.
                                                    </div>
                                                </t>
                                            </div>
                                            
                                            <!-- Tab 2: Documents -->
                                            <div class="tab-pane fade" id="documents" role="tabpanel" aria-labelledby="documents-tab">
                                                <t t-set="docs" t-value="product.env['ir.attachment'].sudo().search([('res_model', '=', 'product.template'), ('res_id', '=', product.id)])"/>
                                                <t t-if="docs">
                                                    <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-4">
                                                        <t t-foreach="docs" t-as="doc">
                                                            <div class="col">
                                                                <div class="doc-grid-item">
                                                                    <!-- Preview / Thumbnail -->
                                                                    <div class="doc-grid-preview">
                                                                        <t t-if="doc.mimetype.startswith('image/')">
                                                                            <img t-attf-src="/web/image/#{doc.id}/200x200" style="width: 100%; height: 100%; object-fit: cover;"/>
                                                                        </t>
                                                                        <t t-else="">
                                                                            <div class="text-center">
                                                                                <i class="fa fa-file-pdf-o text-danger fs-1" t-if="doc.mimetype == 'application/pdf'"></i>
                                                                                <i class="fa fa-file-word-o text-primary fs-1" t-elif="'word' in doc.mimetype"></i>
                                                                                <i class="fa fa-file-excel-o text-success fs-1" t-elif="'excel' in doc.mimetype or 'sheet' in doc.mimetype"></i>
                                                                                <i class="fa fa-file-o text-muted fs-1" t-else=""></i>
                                                                            </div>
                                                                        </t>
                                                                    </div>
                                                                    
                                                                    <!-- Hover Overlay -->
                                                                    <div class="doc-grid-overlay">
                                                                        <t t-if="doc.mimetype.startswith('image/') or doc.mimetype == 'application/pdf'">
                                                                            <button type="button" 
                                                                                    class="btn btn-sm btn-view hover-btn doc-preview-btn"
                                                                                    data-bs-toggle="modal" 
                                                                                    data-bs-target="#docPreviewModal"
                                                                                    t-att-data-url="'/web/content/' + str(doc.id)"
                                                                                    t-att-data-mimetype="doc.mimetype"
                                                                                    t-att-data-title="doc.name">
                                                                                <i class="fa fa-eye me-1"></i> Xem
                                                                            </button>
                                                                        </t>
                                                                        <a t-attf-href="/web/content/#{doc.id}?download=true" class="btn btn-sm btn-primary hover-btn">
                                                                            <i class="fa fa-download me-1"></i> Tải về
                                                                        </a>
                                                                    </div>
                                                                    
                                                                    <!-- Info Bar -->
                                                                    <t t-if="not doc.mimetype.startswith('image/')">
                                                                        <div class="doc-grid-info">
                                                                            <span class="doc-name" t-att-title="doc.name"><t t-esc="doc.name"/></span>
                                                                        </div>
                                                                    </t>
                                                                </div>
                                                            </div>
                                                        </t>
                                                    </div>
                                                </t>
                                                <t t-else="">
                                                    <div class="text-center py-5 text-muted">
                                                        <i class="fa fa-folder-open-o fs-1 mb-3 d-block opacity-50"></i>
                                                        <p class="mb-0">Chưa có tài liệu đính kèm cho sản phẩm này.</p>
                                                    </div>
                                                </t>
                                            </div>
                                            
                                            <!-- Tab 3: Description -->
                                            <t t-if="product.description_sale">
                                                <div class="tab-pane fade" id="description" role="tabpanel" aria-labelledby="description-tab">
                                                    <div class="property-description">
                                                        <t t-esc="product.description_sale"/>
                                                    </div>
                                                </div>
                                            </t>
                                        </div>
                                    </div>
                                </div>

                                <!-- Final Pricing Section -->
                                <div class="row mt-4">
                                    <t t-set="available_discounts" t-value="product.discount_config_ids or product.env['product.discount.config'].sudo().search([('active', '=', True)])"/>
                                    <t t-if="available_discounts">
                                        <div class="col-12">
                                            <div class="card border-0 shadow-sm rounded-3 overflow-hidden mt-2">
                                                <div class="card-header bg-warning bg-opacity-25 border-bottom py-3">
                                                    <h6 class="mb-0 text-uppercase fw-bold text-dark ps-2">
                                                        <i class="fa fa-tags me-2"></i>Chương Trình Giảm Giá Có Thể Áp Dụng
                                                    </h6>
                                                </div>
                                                <div class="card-body p-3">
                                                    <div class="list-group list-group-flush">
                                                        <t t-foreach="available_discounts" t-as="discount">
                                                            <div class="list-group-item border-0 d-flex align-items-center py-2 px-1">
                                                                <div class="form-check fs-5 mb-0">
                                                                    <input class="form-check-input discount-checkbox" 
                                                                           type="checkbox" 
                                                                           t-att-id="'discount_bottom_' + str(discount.id)"
                                                                           t-att-data-id="discount.id"
                                                                           t-att-data-type="discount.discount_type"
                                                                           t-att-data-value="discount.discount_value"
                                                                           style="width: 1.1rem; height: 1.1rem; cursor: pointer;"/>
                                                                </div>
                                                                <label class="form-check-label flex-grow-1 ms-2 fw-semibold text-dark" t-att-for="'discount_bottom_' + str(discount.id)" style="cursor: pointer;">
                                                                    <t t-esc="discount.name"/>
                                                                    <span class="text-danger ms-2">
                                                                        <t t-if="discount.discount_type == 'percent'">(-<t t-esc="discount.discount_value"/>%)</t>
                                                                        <t t-else="">(-<t t-esc="'{:,.0f}'.format(discount.discount_value)"/>)</t>
                                                                    </span>
                                                                </label>
                                                            </div>
                                                        </t>
                                                    </div>
                                                </div>
                                                <div class="card-footer bg-light py-3 ps-4">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div class="text-muted small">
                                                            <i class="fa fa-info-circle me-1"></i> Tích chọn các chương trình để xem giá sau giảm giá.
                                                        </div>
                                                        <div class="fw-bold text-danger fs-5">
                                                            Tiết kiệm tối đa: <span id="totalSavings">0</span> <t t-esc="product.currency_id.symbol"/>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </t>
                                    
                                    <div class="col-12 mt-3">
                                        <div class="card border-0 shadow-sm rounded-3 overflow-hidden bg-warning bg-opacity-25 border-primary border-opacity-25">
                                            <div class="d-flex justify-content-between align-items-center p-4">
                                                <div>
                                                    <h5 class="mb-1 text-uppercase text-primary fw-bold">GIÁ CUỐI CÙNG SAU GIẢM GIÁ</h5>
                                                    <div class="text-muted small">Dựa trên các chương trình giảm giá bạn đã chọn</div>
                                                </div>
                                                <h3 class="mb-0 text-success fw-bold">
                                                    <t t-esc="product.currency_id.symbol or ''"/> 
                                                    <span id="finalPriceValue">
                                                        <t t-esc="'{:,.0f}'.format(product.list_price)"/>
                                                    </span>
                                                </h3>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <script type="text/javascript">
                                    document.addEventListener('DOMContentLoaded', function() {
                                        const checkboxes = document.querySelectorAll('.discount-checkbox');
                                        const listPriceElement = document.getElementById('listPriceValue');
                                        const finalPriceElement = document.getElementById('finalPriceValue');
                                        const savingsElement = document.getElementById('totalSavings');
                                        
                                        if (!listPriceElement || !finalPriceElement) return;
                                        
                                        const listPrice = parseFloat(listPriceElement.getAttribute('data-price'));
                                        
                                        function formatNumber(num) {
                                            return num.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                                        }
                                        
                                        function calculatePrice() {
                                            let totalDiscount = 0;
                                            checkboxes.forEach(cb => {
                                                if (cb.checked) {
                                                    const type = cb.getAttribute('data-type');
                                                    const value = parseFloat(cb.getAttribute('data-value'));
                                                    
                                                    if (type === 'percent') {
                                                        totalDiscount += (listPrice * value / 100);
                                                    } else {
                                                        totalDiscount += value;
                                                    }
                                                }
                                            });
                                            
                                            const finalPrice = Math.max(0, listPrice - totalDiscount);
                                            finalPriceElement.innerText = formatNumber(finalPrice);
                                            savingsElement.innerText = formatNumber(totalDiscount);
                                        }
                                        
                                        checkboxes.forEach(cb => {
                                            cb.addEventListener('change', calculatePrice);
                                        });
                                    });
                                </script>
                            </div>
                        </div>
                    </div>

                    <!-- Document Preview Modal -->
                    <div class="modal fade" id="docPreviewModal" tabindex="-1" aria-labelledby="docPreviewModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-xl modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title fw-bold" id="docPreviewModalLabel">Xem tài liệu</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body p-0 bg-dark d-flex justify-content-center align-items-center" style="min-height: 500px;">
                                    <div id="modalPreviewContent" class="w-100 h-100 d-flex justify-content-center align-items-center">
                                        <!-- Content will be injected by JS -->
                                        <div class="text-white">
                                            <i class="fa fa-spinner fa-spin fa-3x"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                                    <a id="modalDownloadBtn" href="#" class="btn btn-primary" download="true">
                                        <i class="fa fa-download"></i> Tải về
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <script type="text/javascript">
                        document.addEventListener('DOMContentLoaded', function() {
                            const previewModal = document.getElementById('docPreviewModal');
                            if (previewModal) {
                                previewModal.addEventListener('show.bs.modal', function (event) {
                                    const button = event.relatedTarget;
                                    const url = button.getAttribute('data-url');
                                    const mimetype = button.getAttribute('data-mimetype');
                                    const title = button.getAttribute('data-title');
                                    
                                    // Update modal title and download link
                                    const modalTitle = previewModal.querySelector('.modal-title');
                                    const downloadBtn = document.getElementById('modalDownloadBtn');
                                    modalTitle.textContent = title;
                                    downloadBtn.href = url + '?download=true';
                                    
                                    const container = document.getElementById('modalPreviewContent');
                                    container.innerHTML = ''; // Clear spinner
                                    
                                    if (mimetype.startsWith('image/')) {
                                        const img = document.createElement('img');
                                        img.src = url;
                                        img.className = 'img-fluid';
                                        img.style.maxHeight = '80vh';
                                        img.style.objectFit = 'contain';
                                        container.appendChild(img);
                                    } else if (mimetype === 'application/pdf') {
                                        const iframe = document.createElement('iframe');
                                        iframe.src = url + '#toolbar=0';
                                        iframe.width = '100%';
                                        iframe.height = '700px';
                                        iframe.style.border = 'none';
                                        container.appendChild(iframe);
                                    } else {
                                        container.innerHTML = '<div class="text-white p-5 text-center"><i class="fa fa-exclamation-triangle fa-3x mb-3"></i><p>Định dạng này không hỗ trợ xem trực tiếp.</p></div>';
                                    }
                                });
                                
                                // Clear content when modal is hidden to stop audio/video or clear memory
                                previewModal.addEventListener('hidden.bs.modal', function () {
                                    document.getElementById('modalPreviewContent').innerHTML = '';
                                });
                            }
                        });
                    </script>

                    <!-- PDF Download Button Section -->
                    <div class="row mt-4 mb-4">
                        <div class="col-12">
                            <div class="card border-0 shadow-sm rounded-3 overflow-hidden bg-light">
                                <div class="card-body text-center p-4">
                                    <h5 class="mb-3 text-dark">
                                        <i class="fa fa-file-pdf-o text-danger me-2"></i>
                                        Tải xuống thông tin chi tiết
                                    </h5>
                                    <p class="text-muted mb-3">
                                        Tải về tất cả thông tin của căn hộ dưới dạng file PDF để lưu trữ hoặc in ấn
                                    </p>
                                    <a t-attf-href="/my/property/#{product.id}/download-pdf" 
                                       class="btn btn-danger btn-lg px-5 py-3 shadow-sm"
                                       style="font-weight: 600; border-radius: 8px;">
                                        <i class="fa fa-download me-2"></i>
                                        Tải về PDF
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar -->

                </div>
            </div>
        </t>
    </template>

</odoo>

