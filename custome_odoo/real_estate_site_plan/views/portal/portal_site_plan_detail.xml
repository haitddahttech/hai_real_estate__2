<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- Site Plan Detail Page with Interactive Map -->
    <template id="portal_site_plan_detail" name="Site Plan Detail">
        <t t-call="portal.portal_layout">
            <t t-set="additional_title" t-value="site_plan.name"/>
            <t t-set="no_breadcrumbs" t-value="True"/>
            
            <!-- Custom CSS for this page -->
            <style>
                /* Hide default portal breadcrumbs if variable doesn't work */
                .o_portal_submenu {
                    display: none !important;
                }
                
                body {
                    background: #f8f9fa;
                }
                
                .site-plan-header {
                    background: white;
                    border-bottom: 1px solid #edf2f7;
                    padding: 1.5rem 0;
                    margin: -1.5rem -1.5rem 2rem -1.5rem;
                }
                
                .site-plan-title {
                    font-size: 1.75rem;
                    font-weight: 600;
                    margin-bottom: 0.25rem;
                    color: #2d3748;
                }
                
                .site-plan-description {
                    font-size: 0.95rem;
                    color: #718096;
                    margin-bottom: 0;
                }
                
                .map-container {
                    background: white;
                    border-radius: 12px;
                    overflow: hidden;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
                    margin-bottom: 2rem;
                }
                
                .map-toolbar {
                    background: #f8f9fa;
                    padding: 1rem 1.5rem;
                    border-bottom: 1px solid #e9ecef;
                }
                
                .toolbar-btn {
                    background: white;
                    border: 1px solid #dee2e6;
                    border-radius: 6px;
                    padding: 0.5rem 1rem;
                    margin-right: 0.5rem;
                    transition: all 0.2s ease;
                    font-weight: 500;
                    font-size: 0.875rem;
                    color: #495057;
                }
                
                .toolbar-btn:hover {
                    background: #2d3748;
                    border-color: #2d3748;
                    color: white;
                    transform: translateY(-1px);
                }
                
                .toolbar-btn i {
                    margin-right: 0.4rem;
                }
                
                .info-badge {
                    background: #e9ecef;
                    color: #495057;
                    padding: 0.5rem 1rem;
                    border-radius: 6px;
                    font-weight: 500;
                    font-size: 0.875rem;
                    display: inline-block;
                }
                
                #siteMapCanvas {
                    background: #f8f9fa;
                    display: block;
                    margin: 0 auto;
                }
                
                .canvas-wrapper {
                    position: relative;
                    min-height: 600px;
                    background: #f8f9fa;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                }
                
                .legend-card {
                    background: white;
                    border-radius: 12px;
                    padding: 1.5rem;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
                    border: 1px solid #edf2f7;
                }
                
                .legend-title {
                    font-size: 1rem;
                    font-weight: 600;
                    margin-bottom: 1rem;
                    color: #2d3748;
                }
                
                .legend-items {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 1.5rem;
                    justify-content: center;
                }
                
                .legend-item {
                    display: flex;
                    align-items: center;
                    padding: 0.5rem 1rem;
                    background: #f8f9fa;
                    border-radius: 6px;
                    transition: all 0.2s ease;
                }
                
                .legend-item:hover {
                    background: #e9ecef;
                }
                
                .legend-color {
                    width: 24px;
                    height: 24px;
                    border-radius: 4px;
                    margin-right: 0.75rem;
                }
                
                .legend-label {
                    font-weight: 500;
                    color: #4a5568;
                }
                
                .legend-desc {
                    font-size: 0.85rem;
                    color: #718096;
                    margin-left: 0.5rem;
                }
                
                
                .property-popup {
                    border-radius: 12px !important;
                    border: 1px solid rgba(0,0,0,0.08); /* Removed !important - will be overridden by inline style */
                    animation: popupSlideIn 0.25s cubic-bezier(0.4, 0, 0.2, 1);
                    box-shadow: 0 12px 32px rgba(0,0,0,0.1) !important;
                    overflow: hidden;
                    background: white !important;
                    transition: transform 0.15s ease, box-shadow 0.15s ease;
                }
                
                .property-popup.dragging-popup {
                    transform: scale(1.02) !important;
                    box-shadow: 0 20px 48px rgba(0,0,0,0.2) !important;
                    z-index: 1100 !important;
                    opacity: 0.95;
                    will-change: left, top;
                    transition: none !important;
                }
                
                .popup-arrow {
                    will-change: left, top, transform;
                    backface-visibility: hidden;
                }
                
                @keyframes popupSlideIn {
                    from {
                        opacity: 0;
                        transform: translateY(10px) scale(0.98);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0) scale(1);
                    }
                }
                
                .property-popup .card-header {
                    background: #fff !important;
                    border-bottom: 1px solid #f0f0f0 !important;
                    padding: 0.75rem 1rem !important;
                    border-radius: 12px 12px 0 0 !important;
                }

                .property-popup .card-header h6 {
                    font-size: 1rem;
                    font-weight: 700;
                    color: #1a202c;
                    margin: 0;
                }

                .property-popup .btn-close {
                    font-size: 0.7rem;
                    opacity: 0.5;
                    transition: opacity 0.2s;
                }

                .property-popup .btn-close:hover {
                    opacity: 1;
                }

                .property-popup .card-body {
                    padding: 0.75rem 1rem 1rem 1rem !important;
                }

                .property-popup .table td {
                    padding: 0.4rem 0;
                    font-size: 0.85rem;
                    border: none !important;
                }

                .badge-outline {
                    background: transparent !important;
                    border: 1px solid currentColor;
                    font-weight: 500;
                    padding: 0.15rem 0.4rem;
                    font-size: 0.65rem;
                    text-transform: uppercase;
                    letter-spacing: 0.02em;
                }

                .badge-outline-success { color: #28a745; border-color: rgba(40, 167, 69, 0.3); }
                .badge-outline-danger { color: #dc3545; border-color: rgba(220, 53, 69, 0.3); }
                .badge-outline-primary { color: #c9a63f; border-color: rgba(201, 166, 63, 0.3); }
                .badge-outline-info { color: #4a5568; border-color: rgba(74, 85, 104, 0.3); }
                
                .back-btn {
                    background: #2d3748;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    padding: 0.6rem 1.5rem;
                    font-weight: 600;
                    transition: all 0.2s ease;
                    font-size: 0.9rem;
                }
                
                .back-btn:hover {
                    background: #1a202c;
                    color: white;
                    transform: translateX(-3px);
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                }
                
                .canvas-wrapper {
                    position: relative;
                    min-height: 85vh;
                    background: #f8f9fa;
                }
                
                
                .site-map-container {
                    width: 100%;
                    padding-left: 0;
                    padding-right: 0;
                }
                
                /* Desktop / Landscape: 95% Viewport Width (Break out of parent container) */
                @media (min-width: 992px) {
                    .site-map-container {
                        width: 95vw;
                        position: relative;
                        left: 50%;
                        right: 50%;
                        margin-left: -47.5vw;
                        margin-right: -47.5vw;
                        max-width: none !important;
                    }
                }
                
                /* Screenshot optimization */
                .taking-screenshot .property-popup {
                    box-shadow: none !important;
                    border: 1px solid #ccc !important;
                    animation: none !important;
                    transform: none !important;
                }
                .taking-screenshot .property-popup .card-header,
                .taking-screenshot .property-popup .card-body {
                    -webkit-font-smoothing: antialiased;
                }
                /* Decoration images gallery */
                .decoration-images::-webkit-scrollbar {
                    height: 4px;
                }
                .decoration-images::-webkit-scrollbar-track {
                    background: #f1f1f1;
                    border-radius: 4px;
                }
                .decoration-images::-webkit-scrollbar-thumb {
                    background: #ccc;
                    border-radius: 4px;
                }
                .decoration-images::-webkit-scrollbar-thumb:hover {
                    background: #999;
                }
                .decoration-thumb {
                    transition: all 0.2s ease;
                    border: 1px solid #eee;
                }
                .decoration-thumb:hover {
                    opacity: 0.9;
                    transform: scale(1.02);
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
            </style>
            
            <!-- Header Section -->
            <div class="site-plan-header">
                <div class="container">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="site-plan-title">
                                <i class="fa fa-map-marker text-warning"/> <t t-esc="site_plan.name"/>
                            </h1>
                            <t t-if="site_plan.description">
                                <p class="site-plan-description">
                                    <t t-esc="site_plan.description"/>
                                </p>
                            </t>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="d-flex justify-content-end flex-wrap gap-2">
                                <a href="https://www.google.com/maps/d/viewer?mid=1merAHKqWMeZOJfeA-OCTJ2nlcXALB4Id&amp;usp=sharing" 
                                   target="_blank" 
                                   class="back-btn"
                                   style="background: #1a73e8;">
                                    <i class="fa fa-map-marker"/> Xem trên Google Maps
                                </a>
                                <a href="/my/site-plans" class="back-btn">
                                    <i class="fa fa-arrow-left"/> Quay lại
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="site-map-container">
                <!-- Map Section -->
                <div class="row">
                    <div class="col-12">
                        <div class="map-container">
                            <!-- Toolbar -->
                            <div class="map-toolbar">
                                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                                    <div class="d-flex align-items-center gap-2">
                                        <button type="button" class="toolbar-btn" id="toggleZoomLock" title="Khóa/Mở Zoom">
                                            <i class="fa fa-lock"/> Mở Zoom
                                        </button>
                                        <button type="button" class="toolbar-btn" id="resetZoom">
                                            <i class="fa fa-expand"/> Đặt lại
                                        </button>
                                        <button type="button" class="toolbar-btn" id="togglePolygons" title="Ẩn/Hiện Lô đất">
                                            <i class="fa fa-eye-slash"/> Ẩn lô đất
                                        </button>
                                        <button type="button" class="toolbar-btn" id="toggleAllGray" title="Tô xám tất cả">
                                            <i class="fa fa-paint-brush"/> Ẩn sản phẩm
                                        </button>
                                        <button type="button" class="toolbar-btn" id="toggleInteractiveGray" title="Chế độ chọn sản phẩm" style="display: none;">
                                            <i class="fa fa-magic"/> Chọn sản phẩm
                                        </button>
                                        <button type="button" class="toolbar-btn" id="downloadScreenshot" style="background: #28a745; color: white; border-color: #28a745;">
                                            <i class="fa fa-camera"/> Chụp màn hình
                                        </button>
                                    </div>
                                    
                                    <!-- Zoom Slider -->
                                    <div class="d-flex align-items-center gap-2" style="min-width: 200px;">
                                        <i class="fa fa-search-minus text-muted" style="font-size: 0.8rem;"/>
                                        <input type="range" 
                                               id="zoomSlider" 
                                               min="1" 
                                               max="10" 
                                               step="0.1" 
                                               value="1" 
                                               class="form-range"
                                               style="flex: 1;"/>
                                        <i class="fa fa-search-plus text-muted" style="font-size: 0.8rem;"/>
                                        <span id="zoomLevel" class="badge bg-secondary" style="min-width: 45px; font-size: 0.75rem;">100%</span>
                                    </div>
                                    
<!--                                    <div class="info-badge">-->
<!--                                        <i class="fa fa-hand-pointer-o"/> Nhấp vào bất động sản để xem chi tiết-->
<!--                                    </div>-->
                                </div>
                            </div>
                            
                            <!-- Canvas -->
                            <div class="canvas-wrapper">
                                <canvas id="siteMapCanvas" style="cursor: pointer;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Legend Section -->
                <div class="row">
<!--                    <div class="col-12">-->
<!--                        <div class="legend-card">-->
<!--                            <h5 class="legend-title">-->
<!--                                <i class="fa fa-info-circle text-primary"/> Chú thích trạng thái-->
<!--                            </h5>-->
<!--                            <div class="legend-items">-->
<!--                                <div class="legend-item">-->
<!--                                    <div class="legend-color" style="border: 1px solid #3498db; background: transparent;"></div>-->
<!--                                    <div>-->
<!--                                        <span class="legend-label">Còn trống</span>-->
<!--                                        <span class="legend-desc">- Trong suốt (Sẵn sàng)</span>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                                <div class="legend-item">-->
<!--                                    <div class="legend-color" style="background: #cccccc;"></div>-->
<!--                                    <div>-->
<!--                                        <span class="legend-label">Đã bán</span>-->
<!--                                        <span class="legend-desc">- Màu xám</span>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                                <div class="legend-item">-->
<!--                                    <div class="legend-color" style="background: rgba(231, 76, 60, 0.4); border: 1px solid #e74c3c;"></div>-->
<!--                                    <div>-->
<!--                                        <span class="legend-label">Đang chọn</span>-->
<!--                                        <span class="legend-desc">- Nhấp để xem</span>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                    </div>-->
                </div>
            </div>

            <!-- Pass data to JavaScript -->
            <script type="text/javascript">
                var siteMapData = {
                    imageUrl: '<t t-if="site_plan.image_path" t-esc="site_plan.image_path"/><t t-else="">/web/content/site.plan/<t t-esc="site_plan.id"/>/image</t>',
                    polygons: <t t-raw="polygon_data_json"/>
                };
            </script>
            
            <!-- Load html2canvas library for screenshot -->
            <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
            
            <!-- Load custom JS -->
            <script type="text/javascript" src="/real_estate_site_plan/static/src/js/portal_site_map.js"></script>
        </t>
    </template>

</odoo>
